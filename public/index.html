<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>KAIDA - Affiliate Link Tracker</title>
    <style>
        body { font-family: sans-serif; max-width: 1000px; margin: 20px auto; padding: 0 20px; color: #333; }
        table { width: 100%; border-collapse: collapse; margin-top: 20px; }
        th, td { border: 1px solid #ddd; padding: 12px; text-align: left; }
        th { background-color: #f8f9fa; }
        .status-active { color: #28a745; font-weight: bold; }
        .status-down { color: #dc3545; font-weight: bold; }
        form { background: #f1f3f5; padding: 25px; border-radius: 12px; margin-bottom: 30px; }
        input[type="text"], input[type="url"] { padding: 10px; border: 1px solid #ced4da; border-radius: 4px; margin-right: 10px; }
        button { padding: 10px 20px; background-color: #007bff; color: white; border: none; border-radius: 4px; cursor: pointer; transition: background 0.2s; }
        button:hover { background-color: #0056b3; }
        .alert-item { background: #fff5f5; border-left: 5px solid #ff6b6b; padding: 15px; margin: 10px 0; border-radius: 4px; }
        .analytics-pane { display: none; background: #fff; border: 1px solid #dee2e6; padding: 20px; margin-top: 20px; border-radius: 8px; box-shadow: 0 4px 6px rgba(0,0,0,0.1); }
        .close-btn { float: right; cursor: pointer; font-weight: bold; font-size: 20px; }
        .stat-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-top: 15px; }
        .stat-card { border: 1px solid #eee; padding: 15px; border-radius: 6px; }
        .btn-small { padding: 5px 10px; font-size: 12px; }
    </style>
</head>
<body>
    <h1>KAIDA Tracker</h1>

    <div id="emailInfo" style="margin-bottom: 20px; font-size: 14px; color: #666;">
        <!-- Email config status will be shown here -->
    </div>

    <form id="shortenForm">
        <h3>Shorten a Link</h3>
        <input type="url" id="originalUrl" placeholder="https://example.com/affiliate-id" style="width: 400px;" required>
        <input type="text" id="customSlug" placeholder="custom-slug (optional)" style="width: 180px;">
        <button type="submit">Shorten</button>
    </form>

    <div id="result" style="margin-bottom: 20px; font-weight: bold; color: #007bff;"></div>

    <h2>Recent Alerts</h2>
    <div id="alertsList"></div>

    <h2>Tracked Links</h2>
    <table>
        <thead>
            <tr>
                <th>Original URL</th>
                <th>Short Link</th>
                <th>Clicks</th>
                <th>Conversions</th>
                <th>Status</th>
                <th>Actions</th>
            </tr>
        </thead>
        <tbody id="linksTableBody"></tbody>
    </table>

    <div id="analyticsPane" class="analytics-pane">
        <span class="close-btn" onclick="closeAnalytics()">&times;</span>
        <h3 id="analyticsTitle">Analytics</h3>
        <div class="stat-grid">
            <div class="stat-card">
                <h4>Top Referrers</h4>
                <ul id="referrersList"></ul>
            </div>
            <div class="stat-card">
                <h4>Daily Activity (Last 7 Days)</h4>
                <ul id="dailyStatsList"></ul>
            </div>
        </div>
    </div>

    <script>
        const form = document.getElementById('shortenForm');
        const linksTableBody = document.getElementById('linksTableBody');
        const alertsList = document.getElementById('alertsList');
        const analyticsPane = document.getElementById('analyticsPane');

        async function loadData() {
            try {
                const resConfig = await fetch('/api/config-status');
                const config = await resConfig.json();
                document.getElementById('emailInfo').textContent = config.emailEnabled ?
                    '✅ Email notifications enabled' :
                    '⚠️ Email notifications disabled (configure SMTP in .env)';

                const resLinks = await fetch('/api/links');
                const links = await resLinks.json();

                linksTableBody.innerHTML = '';
                links.forEach(link => {
                    const tr = document.createElement('tr');

                    const tdUrl = document.createElement('td');
                    tdUrl.textContent = link.original_url.length > 50 ? link.original_url.substring(0, 47) + '...' : link.original_url;
                    tr.appendChild(tdUrl);

                    const tdShort = document.createElement('td');
                    const aShort = document.createElement('a');
                    aShort.href = '/' + link.slug;
                    aShort.textContent = '/' + link.slug;
                    aShort.target = '_blank';
                    tdShort.appendChild(aShort);
                    tr.appendChild(tdShort);

                    const tdClicks = document.createElement('td');
                    tdClicks.textContent = link.clicks;
                    tr.appendChild(tdClicks);

                    const tdConv = document.createElement('td');
                    tdConv.textContent = link.conversions;
                    tr.appendChild(tdConv);

                    const tdStatus = document.createElement('td');
                    tdStatus.textContent = link.status;
                    tdStatus.className = 'status-' + link.status;
                    tr.appendChild(tdStatus);

                    const tdActions = document.createElement('td');
                    const btn = document.createElement('button');
                    btn.textContent = 'View Analytics';
                    btn.className = 'btn-small';
                    btn.onclick = () => showAnalytics(link.slug);
                    tdActions.appendChild(btn);
                    tr.appendChild(tdActions);

                    linksTableBody.appendChild(tr);
                });

                const resAlerts = await fetch('/api/alerts');
                const alerts = await resAlerts.json();
                alertsList.innerHTML = '';
                if (alerts.length === 0) alertsList.innerHTML = '<p>No recent alerts.</p>';
                alerts.forEach(alert => {
                    const div = document.createElement('div');
                    div.className = 'alert-item';
                    div.textContent = `${new Date(alert.created_at).toLocaleString()}: ${alert.message}`;
                    alertsList.appendChild(div);
                });
            } catch (err) {
                console.error('Failed to load data:', err);
            }
        }

        async function showAnalytics(slug) {
            const res = await fetch(`/api/analytics/${slug}`);
            const data = await res.json();

            document.getElementById('analyticsTitle').textContent = `Analytics for /${slug}`;

            const refList = document.getElementById('referrersList');
            refList.innerHTML = data.referrers.length ?
                data.referrers.map(r => `<li>${r.referrer || 'Direct'}: ${r.count}</li>`).join('') :
                '<li>No data yet</li>';

            const dailyList = document.getElementById('dailyStatsList');
            dailyList.innerHTML = data.dailyStats.length ?
                data.dailyStats.map(s => `<li>${s.date} (${s.type}): ${s.count}</li>`).join('') :
                '<li>No activity in last 7 days</li>';

            analyticsPane.style.display = 'block';
            analyticsPane.scrollIntoView({ behavior: 'smooth' });
        }

        function closeAnalytics() {
            analyticsPane.style.display = 'none';
        }

        form.onsubmit = async (e) => {
            e.preventDefault();
            const original_url = document.getElementById('originalUrl').value;
            const custom_slug = document.getElementById('customSlug').value;

            const res = await fetch('/api/links', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ original_url, custom_slug })
            });

            const data = await res.json();
            if (res.ok) {
                const resultDiv = document.getElementById('result');
                resultDiv.innerHTML = 'Short URL: ';
                const a = document.createElement('a');
                a.href = data.short_url;
                a.textContent = data.short_url;
                a.target = '_blank';
                resultDiv.appendChild(a);
                form.reset();
                loadData();
            } else {
                alert(data.error || 'Something went wrong');
            }
        };

        loadData();
        setInterval(loadData, 30000);
    </script>
</body>
</html>
